<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>[HELIOS] $17 Million NTC Competition Leaderboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet"/>
  <style>
    .font-lato { font-family: 'Lato', sans-serif; }
    th.sortable { cursor: pointer; user-select: none; }

    /* Suns background under rows but above hover backgrounds */
    .table-with-suns {
      position: relative;
      overflow: hidden;
    }
    .table-with-suns::after {
      content: '';
      position: absolute;
      inset: 0;
      background: url('assets/suns.png') center/cover no-repeat;
      opacity: 0.07;
      pointer-events: none;
      z-index: 1;
    }
    .table-with-suns tr { position: relative; z-index: 0; }
    .table-with-suns th,
    .table-with-suns td { position: relative; z-index: 2; }
  </style>
</head>
<body class="bg-slate-900 text-gray-200 min-h-screen p-8 font-sans">
  <h1 class="text-4xl font-extrabold mb-2 text-yellow-400">
    [HELIOS] $17 Million NTC Competition Leaderboard
  </h1>
  <p class="text-sm italic text-gray-400 mb-6">
    Last updated: <span id="updated-at" class="font-mono">Loading…</span>
  </p>

  <!-- Mode toggles -->
  <div class="flex space-x-4 mb-4">
    <button id="mode-tourney" class="px-3 py-1 bg-slate-700 text-sm rounded">Tournament</button>
    <button id="mode-streak"  class="px-3 py-1 bg-slate-700 text-sm rounded">Streaks</button>
  </div>
  <div id="streak-options" class="hidden flex space-x-2 mb-4">
    <button id="streak-current" class="px-2 py-1 bg-slate-700 text-sm rounded">Current</button>
    <button id="streak-all"     class="px-2 py-1 bg-slate-700 text-sm rounded">All Time</button>
  </div>

  <div class="flex space-x-6">
    <!-- Main table -->
    <div class="w-3/4 overflow-x-auto rounded-lg">
      <table id="leaderboard-table"
             class="min-w-full table-with-suns bg-slate-800/70 border-2 border-yellow-400 rounded-lg">
        <thead id="leaderboard-head" class="bg-slate-700"></thead>
        <tbody id="leaderboard-body" class="divide-y divide-slate-700"></tbody>
      </table>
    </div>

    <!-- Info boxes (unchanged) -->
    <div class="w-1/4 space-y-6">
      <!-- ... your existing info boxes ... -->
    </div>
  </div>

  <script>
    // --- Countdown (unchanged) ---
    const cdEl = document.getElementById('countdown'), btn = document.getElementById('toggle-countdown');
    let exact = true;
    function updateCd(){
      const end=new Date('2025-07-23T08:00:00-07:00'),
            diff=Math.max(0,end-new Date()),
            days=Math.floor(diff/86400000),
            hrs=Math.floor((diff%86400000)/3600000),
            mins=Math.floor((diff%3600000)/60000),
            secs=Math.floor((diff%60000)/1000);
      cdEl.textContent = exact
        ? `${String(days).padStart(2,'0')}:${String(hrs).padStart(2,'0')}:`
          +`${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`
        : days;
    }
    btn.addEventListener('click', ()=>{ exact=!exact; btn.textContent= exact?'Show days only':'Show exact countdown'; updateCd(); });
    setInterval(updateCd,1000);
    updateCd();

    // --- State & sorting flags ---
    let data = null,
        mode = 'tourney',
        streakView = 'current',
        tourneySort = { join:false, last:false, races:false },
        streakSort = { start:false, end:false, length:false };

    // --- Toggle handlers ---
    document.getElementById('mode-tourney').onclick = ()=>{
      mode='tourney';
      document.getElementById('streak-options').classList.add('hidden');
      render();
    };
    document.getElementById('mode-streak').onclick = ()=>{
      mode='streak';
      document.getElementById('streak-options').classList.remove('hidden');
      render();
    };
    document.getElementById('streak-current').onclick = ()=>{
      streakView='current'; render();
    };
    document.getElementById('streak-all').onclick = ()=>{
      streakView='allTime'; render();
    };

    // --- Fetch data.json relatively ---
    document.addEventListener('DOMContentLoaded', ()=>{
      const parts=window.location.pathname.split('/'); parts.pop();
      const base=(parts.join('/')||'/').replace(/\/$/,'');
      fetch(`${base}/data.json`)
        .then(r=>{ if(!r.ok) throw new Error(r.status); return r.json(); })
        .then(d=>{ data=d; document.getElementById('updated-at').textContent=d.last_updated||'Unknown'; render(); })
        .catch(e=>{ console.error('data.json load failed',e); document.getElementById('updated-at').textContent='Error'; });
    });

    // --- Main render dispatcher ---
    function render(){
      if(!data) return;
      const tbl = document.getElementById('leaderboard-table');
      if(mode==='tourney'){
        tbl.classList.add('table-with-suns');
        tbl.classList.replace('border-slate-700','border-yellow-400');
        renderTHead(); attachTourneySort();
        renderTBody();
      } else {
        tbl.classList.remove('table-with-suns');
        tbl.classList.replace('border-yellow-400','border-slate-700');
        renderSHead(); attachStreakSort();
        renderSBody();
      }
    }

    // --- Tournament header + sort attachments ---
    function renderTHead(){
      document.getElementById('leaderboard-head').innerHTML=`
      <tr>
        <th>#</th>
        <th>Name & Title</th>
        <th>Role</th>
        <th id="th-join"   class="sortable">Member Since <span>${tourneySort.join?'▲':'▼'}</span></th>
        <th id="th-last"   class="sortable">Last Race     <span>${tourneySort.last?'▲':'▼'}</span></th>
        <th id="th-races"  class="sortable">Races         <span>${tourneySort.races?'▲':'▼'}</span></th>
      </tr>`;
    }
    function attachTourneySort(){
      ['join','last','races'].forEach(k=>{
        document.getElementById(`th-${k}`).onclick = ()=>{
          tourneySort[k]=!tourneySort[k];
          render();
        };
      });
    }

    // --- Streaks header + sort attachments ---
    function renderSHead(){
      document.getElementById('leaderboard-head').innerHTML=`
      <tr>
        <th>#</th>
        <th>Name & Title</th>
        <th>Role</th>
        <th id="th-start"  class="sortable">Streak Start <span>${streakSort.start?'▲':'▼'}</span></th>
        <th id="th-end"    class="sortable">Streak End   <span>${streakSort.end?'▲':'▼'}</span></th>
        <th id="th-length" class="sortable">Length       <span>${streakSort.length?'▲':'▼'}</span></th>
      </tr>`;
    }
    function attachStreakSort(){
      ['start','end','length'].forEach(k=>{
        document.getElementById(`th-${k}`).onclick = ()=>{
          streakSort[k]=!streakSort[k];
          render();
        };
      });
    }

    // --- Tournament body ---
    function renderTBody(){
      let rows = [...data.board];
      // apply sorting
      ['join','last','races'].forEach((k,i)=>{
        if(tourneySort[k]){
          const dir = tourneySort[k]?1:-1;
          rows.sort((a,b)=>{
            const va = k==='races'? a.delta : a[ i===0?'joinStamp':'lastActivity' ];
            const vb = k==='races'? b.delta : b[ i===0?'joinStamp':'lastActivity' ];
            return dir*(va - vb);
          });
        }
      });
      const tb = document.getElementById('leaderboard-body');
      tb.innerHTML='';
      let lastDelta=null, lastRank=0;
      rows.forEach((it,idx)=>{
        const rank=(it.delta!==lastDelta)?idx+1:lastRank;
        lastDelta=it.delta; lastRank=rank;
        // style top3
        let base='', hover='hover:bg-slate-700';
        if(rank===1){ base='bg-yellow-400/20'; hover='hover:bg-yellow-400/10'; }
        if(rank===2){ base='bg-yellow-500/20'; hover='hover:bg-yellow-500/10'; }
        if(rank===3){ base='bg-yellow-600/20'; hover='hover:bg-yellow-600/10'; }
        // ordinal image
        let ord = `${rank}`;
        if(rank===1) ord=`<img src="assets/1st.png" alt="1st" class="h-6 inline"/>`;
        if(rank===2) ord=`<img src="assets/2nd.png" alt="2nd" class="h-6 inline"/>`;
        if(rank===3) ord=`<img src="assets/3rd.png" alt="3rd" class="h-6 inline"/>`;
        // role badge
        const key=it.role.toLowerCase().replace(/\s+/g,''),
              rc = {
                officer:     'border-2 border-blue-400 text-blue-400 bg-transparent',
                captain:     'border-2 border-purple-400 text-purple-400 bg-transparent',
                vicecaptain: 'border-2 border-green-400 text-green-400 bg-transparent',
                member:      'text-gray-400'
              }[key]||'text-gray-400',
              label = key==='vicecaptain'?'Vice Captain'
                    : it.role.charAt(0).toUpperCase()+it.role.slice(1);
        const jd = it.joinStamp? 
          new Date(it.joinStamp*1000).toLocaleDateString() : 'N/A',
              ld = it.lastActivity?
          new Date(it.lastActivity*1000).toLocaleDateString():'N/A',
              tc = rank<=3?'text-yellow-400/70':'text-gray-400',
              th = it.title?`<div class="text-xs ${tc} mt-1">${it.title}</div>`:'';
        const tr=document.createElement('tr');
        tr.className=`cursor-pointer ${base} ${hover} align-middle`;
        tr.onclick=()=> window.open(`https://www.nitrotype.com/racer/${it.username}`,'_blank');
        tr.title='View Nitro Type profile';
        tr.innerHTML=`
          <td class="px-4 py-3">${ord}</td>
          <td class="px-4 py-3 text-yellow-300 font-semibold">${it.displayName}${th}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-0.5 rounded ${rc} text-xs font-medium">${label}</span>
          </td>
          <td class="px-4 py-3">${jd}</td>
          <td class="px-4 py-3">${ld}</td>
          <td class="px-4 py-3 text-right">${it.delta||0}</td>`;
        tb.appendChild(tr);
      });
    }

    // --- Streak body (mirrors tournament styling) ---
    function renderSBody(){
      let rows = [...data.streaks[streakView]];
      ['start','end','length'].forEach((k,i)=>{
        if(streakSort[k]){
          const dir = streakSort[k]?1:-1;
          rows.sort((a,b)=>{
            const va = k==='length'? a.length : a[k], vb = k==='length'? b.length : b[k];
            return dir*( (va||0) - (vb||0) );
          });
        }
      });
      const tb = document.getElementById('leaderboard-body');
      tb.innerHTML='';
      rows.forEach((it,idx)=>{
        const rank=idx+1;
        let base='', hover='hover:bg-slate-700';
        if(rank===1){ base='bg-yellow-400/20'; hover='hover:bg-yellow-400/10'; }
        if(rank===2){ base='bg-yellow-500/20'; hover='hover:bg-yellow-500/10'; }
        if(rank===3){ base='bg-yellow-600/20'; hover='hover:bg-yellow-600/10'; }
        let ord=`${rank}`;
        if(rank===1) ord=`<img src="assets/1st.png" alt="1st" class="h-6 inline"/>`;
        if(rank===2) ord=`<img src="assets/2nd.png" alt="2nd" class="h-6 inline"/>`;
        if(rank===3) ord=`<img src="assets/3rd.png" alt="3rd" class="h-6 inline"/>`;
        const key=it.role.toLowerCase().replace(/\s+/g,''),
              rc = {
                officer:     'border-2 border-blue-400 text-blue-400 bg-transparent',
                captain:     'border-2 border-purple-400 text-purple-400 bg-transparent',
                vicecaptain: 'border-2 border-green-400 text-green-400 bg-transparent',
                member:      'text-gray-400'
              }[key]||'text-gray-400',
              label = key==='vicecaptain'?'Vice Captain'
                    : it.role.charAt(0).toUpperCase()+it.role.slice(1),
              sd = it.start? new Date(it.start).toLocaleDateString() : 'N/A',
              ed = it.end  ? new Date(it.end  ).toLocaleDateString() : 'N/A',
              tc = rank<=3?'text-yellow-400/70':'text-gray-400',
              th = it.title?`<div class="text-xs ${tc} mt-1">${it.title}</div>`:'';
        const tr=document.createElement('tr');
        tr.className=`cursor-pointer ${base} ${hover} align-middle`;
        tr.onclick=()=> window.open(`https://www.nitrotype.com/racer/${it.username}`,'_blank');
        tr.title='View Nitro Type profile';
        tr.innerHTML=`
          <td class="px-4 py-3">${ord}</td>
          <td class="px-4 py-3 text-yellow-300 font-semibold">${it.displayName}${th}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-0.5 rounded ${rc} text-xs font-medium">${label}</span>
          </td>
          <td class="px-4 py-3">${sd}</td>
          <td class="px-4 py-3">${ed}</td>
          <td class="px-4 py-3 text-right">${it.length||0}</td>`;
        tb.appendChild(tr);
      });
    }
  </script>
</body>
</html>
